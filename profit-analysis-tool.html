<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unshakable Fix & Flip Deal Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Base styling adhering to the brand guide */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Charcoal */
            color: #FFFFFF;
        }

        /* Custom styles for branded sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4A5568; /* Slate gray for track */
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        input[type="range"]:hover {
            opacity: 1;
        }

        /* Thumb (the slider handle) styling */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background-image: linear-gradient(to right, #C84A00, #FF6A00); /* Fire Gradient */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #FFFFFF;
            margin-top: -8px; /* Center thumb on the track */
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background-image: linear-gradient(to right, #C84A00, #FF6A00); /* Fire Gradient */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #FFFFFF;
        }

        /* Custom styles for inputs */
        input[type="number"], input[type="email"], input[type="text"], textarea {
            background-color: #2D3748; /* Darker slate */
            color: #FFFFFF;
            border: 1px solid #4A5568;
            -moz-appearance: textfield; /* Firefox */
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Gradient text for key metrics */
        .gradient-text {
            background-image: linear-gradient(to right, #F2C14E, #FFC94E); /* Gold Gradient */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Sensitivity Table Styling */
        #profit_table_container {
             overflow-x: auto;
        }
        #profit_table th, #profit_table td {
            white-space: nowrap;
            padding: 0.6rem 0.85rem;
            text-align: center;
        }
        #profit_table th {
            background-color: #1a202c;
        }
        #profit_table td.in-range {
            background-color: rgba(16, 185, 129, 0.1);
        }
        #profit_table td.current-deal {
            background-image: linear-gradient(to right, #c84a00, #ff6a00) !important;
            color: #FFFFFF;
            font-weight: bold;
            outline: 2px solid #FFC94E;
        }
        .prose-custom ul {
            list-style-position: inside;
            padding-left: 0;
        }
        .prose-custom ul > li::marker {
            color: #FFC94E;
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">
        <div class="w-full max-w-7xl mx-auto">
            
            <!-- Header -->
            <header class="text-center mb-10">
                <img src="https://storage.googleapis.com/msgsndr/zQh0YM3EIsWgcjMDTSSC/media/68a5e3a77d00efbb5c207876.png" alt="Unshakable Investor Logo" class="mx-auto h-16 w-auto mb-4">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black uppercase tracking-tight text-white">
                    Fix & Flip Deal Analyzer
                </h1>
                <p class="mt-2 text-lg text-slate-400">
                    Make decisions with numbers, not emotion. Adjust the sliders to analyze your deal potential.
                </p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">

                <!-- Left Column: Inputs -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-700">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i data-lucide="sliders-horizontal" class="mr-3 text-amber-400"></i>
                            Deal Inputs
                        </h2>

                        <div class="space-y-4 mb-6 border-b border-slate-700 pb-6">
                            <div>
                                <label for="property_address" class="font-semibold text-white">Property Address</label>
                                <input type="text" id="property_address" class="w-full p-2 rounded-md mt-1" placeholder="e.g., 123 Main St, Anytown, USA">
                            </div>
                            <div>
                                <label for="sqft_input" class="font-semibold text-white">Square Footage (SQFT)</label>
                                <input type="number" id="sqft_input" class="w-full p-2 rounded-md mt-1" placeholder="e.g., 1500">
                            </div>
                        </div>

                        <!-- ARV Input -->
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between items-baseline">
                                <label for="arv" class="font-semibold text-white">After-Repair Value (ARV)</label>
                                <div class="flex items-center gap-3">
                                    <span id="arv_per_sqft" class="text-sm text-slate-400 whitespace-nowrap"></span>
                                    <input type="number" id="arv_input" class="w-32 text-right p-1 rounded-md" value="515000">
                                </div>
                            </div>
                            <input type="range" id="arv_slider" min="50000" max="2000000" step="1" value="515000" class="w-full">
                        </div>

                        <!-- Purchase Price Input -->
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between items-baseline">
                                <label for="purchase_price" class="font-semibold text-white">Purchase Price</label>
                                 <div class="flex items-center gap-3">
                                    <span id="purchase_price_per_sqft" class="text-sm text-slate-400 whitespace-nowrap"></span>
                                    <input type="number" id="purchase_price_input" class="w-32 text-right p-1 rounded-md" value="345000">
                                </div>
                            </div>
                            <input type="range" id="purchase_price_slider" min="10000" max="1500000" step="1" value="345000" class="w-full">
                        </div>

                        <!-- Rehab Costs Input -->
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between items-baseline">
                                <label for="rehab_costs" class="font-semibold text-white">Rehab Costs</label>
                                <div class="flex items-center gap-3">
                                    <span id="rehab_costs_per_sqft" class="text-sm text-slate-400 whitespace-nowrap"></span>
                                    <input type="number" id="rehab_costs_input" class="w-32 text-right p-1 rounded-md" value="45000">
                                </div>
                            </div>
                            <input type="range" id="rehab_costs_slider" min="0" max="500000" step="1" value="45000" class="w-full">
                        </div>

                         <!-- Min. Target Profit Input -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <label for="target_profit_input" class="font-semibold text-white flex items-center">
                                    Min. Target Profit
                                    <i data-lucide="info" class="w-4 h-4 ml-2 text-slate-400 cursor-pointer" title="Auto-calculated as the greater of $30k or 10% of ARV (max $100k), but you can override it."></i>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                                    <input type="number" id="target_profit_input" class="w-32 text-right p-1 rounded-md pl-6" value="40000">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-700">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i data-lucide="landmark" class="mr-3 text-amber-400"></i>
                            Financing Assumptions
                        </h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label for="ltv_input" class="font-medium text-slate-300">Loan to Cost (%)</label>
                                <input type="number" id="ltv_input" class="w-24 text-right p-1 rounded-md" value="75">
                            </div>
                             <div class="flex justify-between items-center">
                                <label for="interest_rate_input" class="font-medium text-slate-300">Interest Rate (%)</label>
                                <input type="number" id="interest_rate_input" class="w-24 text-right p-1 rounded-md" value="12">
                            </div>
                             <div class="flex justify-between items-center">
                                <label for="holding_period_input" class="font-medium text-slate-300">Holding Period (Months)</label>
                                <input type="number" id="holding_period_input" class="w-24 text-right p-1 rounded-md" value="6">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Analysis -->
                <div class="lg:col-span-3">
                    <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-700">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                           <i data-lucide="bar-chart-2" class="mr-3 text-amber-400"></i>
                            Profit Analysis
                        </h2>
                        
                        <!-- Key Metrics -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                            <div id="net_profit_card" class="p-4 rounded-lg border border-slate-700 transition-all duration-300">
                                <p class="text-sm font-medium text-slate-400">NET PROFIT</p>
                                <p id="net_profit" class="text-4xl font-bold"></p>
                            </div>
                             <div class="p-4 rounded-lg bg-black/20 border border-slate-700">
                                <p class="text-sm font-medium text-slate-400">RETURN ON INVESTMENT (ROI)</p>
                                <p id="roi" class="text-4xl font-bold gradient-text"></p>
                            </div>
                             <div class="p-4 rounded-lg bg-black/20 border border-slate-700">
                                <p class="text-sm font-medium text-slate-400">PROFIT MARGIN (% OF ARV)</p>
                                <p id="profit_margin" class="text-4xl font-bold gradient-text"></p>
                            </div>
                            <div class="p-4 rounded-lg bg-black/20 border border-slate-700">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-slate-400">UPFRONT ACQUISITION COST</p>
                                    <i id="toggle_acquisition_calc" data-lucide="chevron-down" class="w-5 h-5 text-slate-500 cursor-pointer transition-transform"></i>
                                </div>
                                <p id="acquisition_cost" class="text-2xl font-semibold"></p>
                                <div id="acquisition_calc" class="hidden mt-2 text-xs text-slate-400 bg-slate-800 p-2 rounded"></div>
                            </div>
                            <div class="p-4 rounded-lg bg-black/20 border border-slate-700">
                                 <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-slate-400">EST. LOAN AMOUNT</p>
                                    <i id="toggle_loan_calc" data-lucide="chevron-down" class="w-5 h-5 text-slate-500 cursor-pointer transition-transform"></i>
                                </div>
                                <p id="loan_amount" class="text-2xl font-semibold"></p>
                                <div id="loan_calc" class="hidden mt-2 text-xs text-slate-400 bg-slate-800 p-2 rounded"></div>
                            </div>
                           
                            <div id="cost_basis_card" class="p-4 rounded-lg bg-black/20 border border-slate-700">
                                <p class="text-sm font-medium text-slate-400">PURCHASE + REHAB % OF ARV</p>
                                <p id="cost_basis_percent" class="text-4xl font-bold"></p>
                            </div>
                        </div>

                        <!-- Cost Breakdown -->
                        <div>
                            <h3 class="font-semibold text-white mb-3">Deal Breakdown</h3>
                            <div class="space-y-2 text-slate-300">
                                <div class="flex justify-between p-2 rounded bg-black/20"><span>After-Repair Value (ARV)</span><span id="breakdown_arv" class="font-bold text-white"></span></div>
                                <div class="flex justify-between p-2 rounded bg-black/20 text-red-400"><span>(-) Total Project Costs</span><span id="total_project_cost" class="font-semibold"></span></div>
                                
                                <div class="ml-4 border-l-2 border-slate-700 pl-4 space-y-2 py-2">
                                    <div class="flex justify-between text-sm"><span>Purchase Price</span><span id="breakdown_purchase"></span></div>
                                    <div class="flex justify-between text-sm"><span>Rehab Costs</span><span id="breakdown_rehab"></span></div>
                                    <div class="flex justify-between text-sm group">
                                        <span class="flex items-center">Holding Costs</span>
                                        <span id="breakdown_holding_total" class="font-semibold"></span>
                                    </div>
                                    <div class="ml-4 border-l-2 border-slate-600 pl-4 space-y-1">
                                        <div class="flex justify-between text-xs"><span>Selling Costs (6% of ARV)</span><span id="breakdown_selling"></span></div>
                                        <div class="flex justify-between text-xs"><span>Financing Costs</span><span id="breakdown_financing"></span></div>
                                        <div class="flex justify-between text-xs"><span>Closing Costs (3% of ARV)</span><span id="breakdown_closing"></span></div>
                                    </div>
                                </div>
                                <div class="flex justify-between p-2 rounded bg-green-500/10 text-green-300 border-t-2 border-green-500/30">
                                    <span class="font-bold">(=) NET PROFIT</span>
                                    <span id="breakdown_profit" class="font-bold"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Sensitivity Analysis Table -->
            <section class="mt-8 bg-slate-900/50 p-6 rounded-2xl border border-slate-700">
                 <h2 class="text-2xl font-bold text-white mb-2 flex items-center">
                    <i data-lucide="table" class="mr-3 text-amber-400"></i>
                    Profit Sensitivity Analysis
                </h2>
                <p class="text-sm text-slate-400 mb-4">The table below shows how Net Profit changes with different Purchase Prices and Rehab Costs. Green cells meet or exceed your Target Profit.</p>
                <div id="profit_table_container" class="rounded-lg">
                    <table id="profit_table" class="w-full text-sm border-collapse border border-slate-700">
                        <!-- Table will be generated by JS -->
                    </table>
                </div>
            </section>
            
            <!-- AI Deal Summary -->
            <section class="mt-8 bg-slate-900/50 p-6 rounded-2xl border border-slate-700">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <i data-lucide="brain-circuit" class="mr-3 text-amber-400"></i>
                        AI Deal Summary
                    </h2>
                    <button id="generate_ai_summary_btn" class="w-full sm:w-auto bg-gradient-to-r from-slate-600 to-slate-800 hover:from-slate-700 hover:to-slate-900 text-white font-bold py-2 px-5 rounded-md transition-all duration-300 flex items-center justify-center">
                        <span id="ai_btn_text">✨ Generate Deal Summary</span>
                        <span id="ai_btn_spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                    </button>
                </div>
                <div id="ai_summary_output" class="p-4 bg-black/20 rounded-lg min-h-[100px] text-slate-300 prose-custom">
                    <p id="ai_summary_placeholder" class="text-slate-400">Click the button above for a strategic analysis of this deal.</p>
                    <p id="ai_summary_content" class="hidden whitespace-pre-wrap"></p>
                    <p id="ai_summary_error" class="hidden text-red-400"></p>
                </div>
            </section>

            <!-- Webhook Submission -->
            <section class="mt-8 bg-slate-900/50 p-6 rounded-2xl border border-slate-700">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <i data-lucide="mail" class="mr-3 text-amber-400"></i>
                    Get Your Deal Report
                </h2>
                <p class="text-sm text-slate-400 mb-4">Enter your email below to send a copy of this deal analysis to your inbox.</p>
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <input type="email" id="user_email" placeholder="Enter your email address..." class="flex-grow w-full p-3 rounded-md focus:ring-2 focus:ring-amber-500 focus:outline-none transition">
                    <button id="submit_deal_btn" class="w-full sm:w-auto bg-gradient-to-r from-orange-600 to-orange-800 hover:from-orange-700 hover:to-orange-900 text-white font-bold py-3 px-6 rounded-md transition-all duration-300 flex items-center justify-center">
                        <span id="submit_btn_text">Send Me The Report</span>
                        <span id="submit_btn_spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                    </button>
                </div>
                <p id="submit_status" class="text-sm mt-3 text-slate-400 h-4"></p>
            </section>

        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const $ = (selector) => document.getElementById(selector);

            // --- INPUT ELEMENTS ---
            const inputs = {
                propertyAddress: $('property_address'),
                sqft: $('sqft_input'),
                arv: $('arv_input'),
                arvSlider: $('arv_slider'),
                purchasePrice: $('purchase_price_input'),
                purchasePriceSlider: $('purchase_price_slider'),
                rehabCosts: $('rehab_costs_input'),
                rehabCostsSlider: $('rehab_costs_slider'),
                targetProfit: $('target_profit_input'),
                ltv: $('ltv_input'),
                interestRate: $('interest_rate_input'),
                holdingPeriod: $('holding_period_input'),
                userEmail: $('user_email'),
            };

            // --- OUTPUT & UI ELEMENTS ---
            const ui = {
                arvPerSqft: $('arv_per_sqft'),
                purchasePricePerSqft: $('purchase_price_per_sqft'),
                rehabCostsPerSqft: $('rehab_costs_per_sqft'),
                netProfitCard: $('net_profit_card'),
                netProfit: $('net_profit'),
                roi: $('roi'),
                profitMargin: $('profit_margin'),
                acquisitionCost: $('acquisition_cost'),
                acquisitionCalc: $('acquisition_calc'),
                toggleAcquisitionCalc: $('toggle_acquisition_calc'),
                loanAmount: $('loan_amount'),
                loanCalc: $('loan_calc'),
                toggleLoanCalc: $('toggle_loan_calc'),
                costBasisCard: $('cost_basis_card'),
                costBasisPercent: $('cost_basis_percent'),
                totalProjectCost: $('total_project_cost'),
                breakdownArv: $('breakdown_arv'),
                breakdownPurchase: $('breakdown_purchase'),
                breakdownRehab: $('breakdown_rehab'),
                breakdownHoldingTotal: $('breakdown_holding_total'),
                breakdownSelling: $('breakdown_selling'),
                breakdownFinancing: $('breakdown_financing'),
                breakdownClosing: $('breakdown_closing'),
                breakdownProfit: $('breakdown_profit'),
                profitTable: $('profit_table'),
                submitDealBtn: $('submit_deal_btn'),
                submitBtnText: $('submit_btn_text'),
                submitBtnSpinner: $('submit_btn_spinner'),
                submitStatus: $('submit_status'),
                generateAiSummaryBtn: $('generate_ai_summary_btn'),
                aiBtnText: $('ai_btn_text'),
                aiBtnSpinner: $('ai_btn_spinner'),
                aiSummaryPlaceholder: $('ai_summary_placeholder'),
                aiSummaryContent: $('ai_summary_content'),
                aiSummaryError: $('ai_summary_error'),
            };

            // --- HELPER FUNCTION ---
            const formatCurrency = (value, isPerSqFt = false) => {
                if (isNaN(value) || !isFinite(value)) return '$0';
                const options = { 
                    style: 'currency', 
                    currency: 'USD', 
                    minimumFractionDigits: isPerSqFt ? 2 : 0, 
                    maximumFractionDigits: isPerSqFt ? 2 : 0 
                };
                return value.toLocaleString('en-US', options);
            };
            
            // --- CORE CALCULATION LOGIC ---
            function getDealMetrics(arv, purchasePrice, rehabCosts, financingParams, sqft) {
                const { ltv, interestRate, holdingPeriod } = financingParams;
                const sellingCosts = arv * 0.06;
                const closingCosts = arv * 0.03;
                const totalCostBasis = purchasePrice + rehabCosts;
                const loanAmount = totalCostBasis * (ltv / 100);
                const financingCosts = loanAmount * (interestRate / 100 / 12) * holdingPeriod;
                const totalHoldingCosts = sellingCosts + financingCosts + closingCosts;
                const totalProjectCost = purchasePrice + rehabCosts + totalHoldingCosts;
                const netProfit = arv - totalProjectCost;
                const downPayment = totalCostBasis - loanAmount;
                const acquisitionCost = closingCosts + downPayment;
                const roi = acquisitionCost > 0 ? (netProfit / acquisitionCost) * 100 : Infinity;
                const costBasisOfArv = arv > 0 ? (totalCostBasis / arv) * 100 : 0;
                const profitMargin = arv > 0 ? (netProfit / arv) * 100 : 0;
                const arvPerSqft = sqft > 0 ? arv / sqft : 0;
                const purchasePricePerSqft = sqft > 0 ? purchasePrice / sqft : 0;
                const rehabPerSqft = sqft > 0 ? rehabCosts / sqft : 0;
                return { arv, purchasePrice, rehabCosts, sellingCosts, closingCosts, loanAmount, financingCosts, totalHoldingCosts, totalProjectCost, netProfit, acquisitionCost, roi, downPayment, totalCostBasis, ltv, costBasisOfArv, profitMargin, arvPerSqft, purchasePricePerSqft, rehabPerSqft };
            }

            function updateUI() {
                const sqft = parseFloat(inputs.sqft.value) || 0;
                const arv = parseFloat(inputs.arv.value) || 0;
                const purchasePrice = parseFloat(inputs.purchasePrice.value) || 0;
                const rehabCosts = parseFloat(inputs.rehabCosts.value) || 0;
                const targetProfit = parseFloat(inputs.targetProfit.value) || 0;
                const financingParams = { ltv: parseFloat(inputs.ltv.value) || 0, interestRate: parseFloat(inputs.interestRate.value) || 0, holdingPeriod: parseFloat(inputs.holdingPeriod.value) || 0 };
                const metrics = getDealMetrics(arv, purchasePrice, rehabCosts, financingParams, sqft);
                ui.arvPerSqft.textContent = sqft > 0 ? `(${formatCurrency(metrics.arvPerSqft, true)}/sqft)` : '';
                ui.purchasePricePerSqft.textContent = sqft > 0 ? `(${formatCurrency(metrics.purchasePricePerSqft, true)}/sqft)` : '';
                ui.rehabCostsPerSqft.textContent = sqft > 0 ? `(${formatCurrency(metrics.rehabPerSqft, true)}/sqft)` : '';
                ui.netProfit.textContent = formatCurrency(metrics.netProfit);
                ui.roi.textContent = isFinite(metrics.roi) ? `${metrics.roi.toFixed(1)}%` : 'N/A';
                ui.profitMargin.textContent = isFinite(metrics.profitMargin) ? `${metrics.profitMargin.toFixed(1)}%` : 'N/A';
                ui.acquisitionCost.textContent = formatCurrency(metrics.acquisitionCost);
                ui.loanAmount.textContent = formatCurrency(metrics.loanAmount);
                ui.costBasisPercent.textContent = `${metrics.costBasisOfArv.toFixed(1)}%`;
                ui.costBasisPercent.classList.toggle('text-red-400', metrics.costBasisOfArv > 75);
                ui.costBasisPercent.classList.toggle('text-green-400', metrics.costBasisOfArv <= 75);
                ui.acquisitionCalc.innerHTML = `Down Payment: ${formatCurrency(metrics.downPayment)}<br>+ Closing Costs: ${formatCurrency(metrics.closingCosts)}`;
                ui.loanCalc.innerHTML = `(Purchase + Rehab) * LTV<br>(${formatCurrency(metrics.purchasePrice)} + ${formatCurrency(metrics.rehabCosts)}) * ${metrics.ltv}%`;
                ui.breakdownArv.textContent = formatCurrency(metrics.arv);
                ui.totalProjectCost.textContent = formatCurrency(metrics.totalProjectCost);
                ui.breakdownPurchase.textContent = formatCurrency(metrics.purchasePrice);
                ui.breakdownRehab.textContent = formatCurrency(metrics.rehabCosts);
                ui.breakdownHoldingTotal.textContent = formatCurrency(metrics.totalHoldingCosts);
                ui.breakdownSelling.textContent = formatCurrency(metrics.sellingCosts);
                ui.breakdownFinancing.textContent = formatCurrency(metrics.financingCosts);
                ui.breakdownClosing.textContent = formatCurrency(metrics.closingCosts);
                ui.breakdownProfit.textContent = formatCurrency(metrics.netProfit);
                ui.netProfitCard.classList.remove('bg-green-500/20', 'border-green-500', 'bg-red-500/20', 'border-red-500');
                ui.netProfitCard.classList.add(metrics.netProfit >= targetProfit ? 'bg-green-500/20' : 'bg-red-500/20', metrics.netProfit >= targetProfit ? 'border-green-500' : 'border-red-500');
                ui.aiSummaryContent.classList.add('hidden');
                ui.aiSummaryError.classList.add('hidden');
                ui.aiSummaryPlaceholder.textContent = 'Deal data has changed. Click button for an updated analysis.';
                ui.aiSummaryPlaceholder.classList.remove('hidden');
                generateProfitTable(metrics, financingParams, targetProfit, sqft);
            }

            function generateProfitTable(baseMetrics, financingParams, targetProfit, sqft) {
                const basePurchase = baseMetrics.purchasePrice;
                const baseRehab = baseMetrics.rehabCosts;
                const purchaseIncrement = basePurchase * 0.03;
                const rehabIncrement = baseRehab * 0.03 || 1000;
                let tableHTML = '<thead><tr><th class="border border-slate-600 font-bold">PP &darr; | Rehab &rarr;</th>';
                for (let i = -5; i <= 5; i++) { const rehabVal = baseRehab + (i * rehabIncrement); tableHTML += `<th class="border border-slate-600">${formatCurrency(rehabVal)}</th>`; }
                tableHTML += '</tr></thead><tbody>';
                for (let j = 0; j < 6; j++) {
                    const purchaseVal = basePurchase - (j * purchaseIncrement);
                    tableHTML += `<tr><th class="bg-slate-800 border border-slate-600">${formatCurrency(purchaseVal)}</th>`;
                    for (let i = -5; i <= 5; i++) {
                        const rehabVal = baseRehab + (i * rehabIncrement);
                        const cellMetrics = getDealMetrics(baseMetrics.arv, purchaseVal, rehabVal, financingParams, sqft);
                        const inRangeClass = cellMetrics.netProfit >= targetProfit ? 'in-range' : '';
                        const currentDealClass = (i === 0 && j === 0) ? 'current-deal' : '';
                        tableHTML += `<td class="${inRangeClass} ${currentDealClass} border border-slate-700">${formatCurrency(cellMetrics.netProfit)}</td>`;
                    }
                    tableHTML += '</tr>';
                }
                tableHTML += '</tbody>';
                ui.profitTable.innerHTML = tableHTML;
            }

            function updateTargetProfit() {
                const arv = parseFloat(inputs.arv.value) || 0;
                const percentageProfit = arv * 0.10;
                const calculatedTarget = Math.min(100000, Math.max(30000, percentageProfit));
                inputs.targetProfit.value = Math.round(calculatedTarget);
            }

            async function generateAISummary() {
                ui.generateAiSummaryBtn.disabled = true;
                ui.aiBtnText.classList.add('hidden');
                ui.aiBtnSpinner.classList.remove('hidden');
                ui.aiSummaryPlaceholder.classList.add('hidden');
                ui.aiSummaryContent.classList.add('hidden');
                ui.aiSummaryError.classList.add('hidden');
                
                const sqft = parseFloat(inputs.sqft.value) || 0;
                const arv = parseFloat(inputs.arv.value) || 0;
                const purchasePrice = parseFloat(inputs.purchasePrice.value) || 0;
                const rehabCosts = parseFloat(inputs.rehabCosts.value) || 0;
                const targetProfit = parseFloat(inputs.targetProfit.value) || 0;
                const financingParams = { ltv: parseFloat(inputs.ltv.value) || 0, interestRate: parseFloat(inputs.interestRate.value) || 0, holdingPeriod: parseFloat(inputs.holdingPeriod.value) || 0 };
                const metrics = getDealMetrics(arv, purchasePrice, rehabCosts, financingParams, sqft);
                
                const ltvRatio = financingParams.ltv / 100;
                const monthlyInterestRate = financingParams.interestRate / 100 / 12;
                const financingFactor = ltvRatio * monthlyInterestRate * financingParams.holdingPeriod;
                const numerator = arv - purchasePrice - metrics.sellingCosts - metrics.closingCosts - (purchasePrice * financingFactor) - targetProfit;
                const denominator = 1 + financingFactor;
                const whatIfRehab = denominator > 0 ? numerator / denominator : 0;
                
                const systemPrompt = "You are 'Unshakable Investor,' an AI persona modeled after Toby Potter. Your analysis should be direct, authoritative, and action-oriented. Analyze the deal metrics and provide a concise, strategic summary.";
                const userQuery = `Deal Metrics:\n- Address: ${inputs.propertyAddress.value || 'N/A'}\n- SQFT: ${sqft || 'N/A'}\n- ARV: ${formatCurrency(metrics.arv)} (${sqft > 0 ? formatCurrency(metrics.arvPerSqft, true) + '/sqft' : 'N/A'})\n- Purchase Price: ${formatCurrency(metrics.purchasePrice)} (${sqft > 0 ? formatCurrency(metrics.purchasePricePerSqft, true) + '/sqft' : 'N/A'})\n- Rehab Costs: ${formatCurrency(metrics.rehabCosts)} (${sqft > 0 ? formatCurrency(metrics.rehabPerSqft, true) + '/sqft' : 'N/A'})\n- Purchase + Rehab as % of ARV: ${metrics.costBasisOfArv.toFixed(1)}%\n- Net Profit: ${formatCurrency(metrics.netProfit)}\n- Profit Margin: ${isFinite(metrics.profitMargin) ? metrics.profitMargin.toFixed(1) + '%' : 'N/A'}\n- ROI: ${isFinite(metrics.roi) ? metrics.roi.toFixed(1) + '%' : 'N/A'}\n- Target Profit: ${formatCurrency(targetProfit)}\n\nProvide a 'Deal Summary' including:\n1. Analysis of deal strength (ref. Purchase+Rehab % of ARV, profit target).\n2. Primary leverage point for this deal.\n3. A 'what-if' scenario: "If the seller's price is firm, you would need to reduce rehab costs to approximately ${formatCurrency(whatIfRehab)} to hit your minimum target."`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        let errorMsg = `API error: ${response.status} ${response.statusText}`;
                        try { const errorBody = await response.json(); if (errorBody && errorBody.error && errorBody.error.message) { errorMsg += ` - ${errorBody.error.message}`; } } catch (e) {}
                        throw new Error(errorMsg);
                    }
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) { ui.aiSummaryContent.textContent = text; ui.aiSummaryContent.classList.remove('hidden');
                    } else { throw new Error('No content received from AI.'); }
                } catch (error) { console.error('AI Summary generation failed:', error); ui.aiSummaryError.textContent = 'Failed to generate summary. Please try again.'; ui.aiSummaryError.classList.remove('hidden');
                } finally { ui.generateAiSummaryBtn.disabled = false; ui.aiBtnText.classList.remove('hidden'); ui.aiBtnSpinner.classList.add('hidden'); }
            }
            
            function getProfitTableData(baseMetrics, financingParams, sqft) {
                const basePurchase = baseMetrics.purchasePrice; const baseRehab = baseMetrics.rehabCosts; const purchaseIncrement = basePurchase * 0.03; const rehabIncrement = baseRehab * 0.03 || 1000;
                const headers = ['Purchase Price \\ Rehab Cost'];
                for (let i = -5; i <= 5; i++) { headers.push(formatCurrency(baseRehab + (i * rehabIncrement))); }
                const rows = [];
                for (let j = 0; j < 6; j++) {
                    const purchaseVal = basePurchase - (j * purchaseIncrement);
                    const rowData = { purchasePrice: formatCurrency(purchaseVal), profits: {} };
                    for (let i = -5; i <= 5; i++) {
                        const rehabVal = baseRehab + (i * rehabIncrement);
                        const cellMetrics = getDealMetrics(baseMetrics.arv, purchaseVal, rehabVal, financingParams, sqft);
                        rowData.profits[headers[i + 1]] = formatCurrency(cellMetrics.netProfit);
                    }
                    rows.push(rowData);
                }
                return { headers, rows };
            }

            async function sendToWebhook() {
                const email = inputs.userEmail.value;
                if (!email || !email.includes('@')) { ui.submitStatus.textContent = 'Please enter a valid email address.'; ui.submitStatus.classList.add('text-red-400'); return; }
                ui.submitDealBtn.disabled = true; ui.submitBtnText.classList.add('hidden'); ui.submitBtnSpinner.classList.remove('hidden'); ui.submitStatus.textContent = 'Sending...'; ui.submitStatus.classList.remove('text-red-400', 'text-green-400');
                const sqft = parseFloat(inputs.sqft.value) || 0; const arv = parseFloat(inputs.arv.value) || 0; const purchasePrice = parseFloat(inputs.purchasePrice.value) || 0; const rehabCosts = parseFloat(inputs.rehabCosts.value) || 0; const targetProfit = parseFloat(inputs.targetProfit.value) || 0;
                const financingParams = { ltv: parseFloat(inputs.ltv.value) || 0, interestRate: parseFloat(inputs.interestRate.value) || 0, holdingPeriod: parseFloat(inputs.holdingPeriod.value) || 0, };
                const metrics = getDealMetrics(arv, purchasePrice, rehabCosts, financingParams, sqft);
                const tableData = getProfitTableData(metrics, financingParams, sqft);
                const payload = {
                    email,
                    report: {
                        propertyDetails: { address: inputs.propertyAddress.value || 'N/A', sqft: sqft > 0 ? sqft : 'N/A' },
                        dealInputs: { arv: formatCurrency(arv), purchasePrice: formatCurrency(purchasePrice), rehabCosts: formatCurrency(rehabCosts), minTargetProfit: formatCurrency(targetProfit), },
                        financingAssumptions: { ltv: `${financingParams.ltv}%`, interestRate: `${financingParams.interestRate}%`, holdingPeriod: `${financingParams.holdingPeriod} months` },
                        profitAnalysis: { netProfit: formatCurrency(metrics.netProfit), roi: isFinite(metrics.roi) ? `${metrics.roi.toFixed(1)}%` : 'N/A', profitMargin: isFinite(metrics.profitMargin) ? `${metrics.profitMargin.toFixed(1)}%` : 'N/A', upfrontAcquisitionCost: formatCurrency(metrics.acquisitionCost), estLoanAmount: formatCurrency(metrics.loanAmount), costBasisVsArv: `${metrics.costBasisOfArv.toFixed(1)}%`, arvPerSqft: sqft > 0 ? formatCurrency(metrics.arvPerSqft, true) : 'N/A', purchasePricePerSqft: sqft > 0 ? formatCurrency(metrics.purchasePricePerSqft, true) : 'N/A', rehabPerSqft: sqft > 0 ? formatCurrency(metrics.rehabPerSqft, true) : 'N/A' },
                        aiSummary: ui.aiSummaryContent.classList.contains('hidden') ? 'Not generated.' : ui.aiSummaryContent.innerText,
                        sensitivityAnalysis: tableData,
                    }
                };
                try {
                    const response = await fetch('https://hook.us2.make.com/toloqfcv3e31we94yhbvugmvq5n6glof', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if(response.ok) { ui.submitStatus.textContent = 'Deal report sent successfully!'; ui.submitStatus.classList.add('text-green-400');
                    } else { throw new Error('Server responded with an error.'); }
                } catch (error) { console.error('Webhook submission failed:', error); ui.submitStatus.textContent = 'Submission failed. Please try again.'; ui.submitStatus.classList.add('text-red-400');
                } finally { ui.submitDealBtn.disabled = false; ui.submitBtnText.classList.remove('hidden'); ui.submitBtnSpinner.classList.add('hidden'); }
            }

            function setupListeners() {
                Object.values(inputs).forEach(input => { if (input.id !== 'user_email') { input.addEventListener('input', updateUI); } });
                inputs.arvSlider.addEventListener('input', () => inputs.arv.value = inputs.arvSlider.value);
                inputs.arv.addEventListener('input', () => { inputs.arvSlider.value = inputs.arv.value; updateTargetProfit(); });
                inputs.purchasePriceSlider.addEventListener('input', () => inputs.purchasePrice.value = inputs.purchasePriceSlider.value);
                inputs.purchasePrice.addEventListener('input', () => inputs.purchasePriceSlider.value = inputs.purchasePrice.value);
                inputs.rehabCostsSlider.addEventListener('input', () => inputs.rehabCosts.value = inputs.rehabCostsSlider.value);
                inputs.rehabCosts.addEventListener('input', () => inputs.rehabCostsSlider.value = inputs.rehabCosts.value);
                ui.toggleAcquisitionCalc.addEventListener('click', () => { ui.acquisitionCalc.classList.toggle('hidden'); ui.toggleAcquisitionCalc.classList.toggle('rotate-180'); });
                ui.toggleLoanCalc.addEventListener('click', () => { ui.loanCalc.classList.toggle('hidden'); ui.toggleLoanCalc.classList.toggle('rotate-180'); });
                ui.generateAiSummaryBtn.addEventListener('click', generateAISummary);
                ui.submitDealBtn.addEventListener('click', sendToWebhook);
            }
            
            function init() {
                updateTargetProfit();
                updateUI();
                setupListeners();
            }

            init();
        });
    </script>
</body>
</html>